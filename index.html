<!DOCTYPE html>
<html>
<head>
  <title>Noibakes Gift Box</title>
  <style>
    body {
      text-align: center;
      font-family: 'Segoe UI', sans-serif;
      background: #fffaf0;
      color: #333;
    }
    .gift-box {
      font-size: 3em;
      cursor: pointer;
      margin-top: 40px;
    }
    .coupon {
      margin-top: 30px;
      font-weight: bold;
      font-size: 1.4em;
      padding: 10px;
    }
    .form-section, .gift-section {
      margin-top: 50px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <h2>üéâ Noibakes Fest Gift Box üéâ</h2>

  <div class="form-section" id="formSection">
    <form id="userForm">
      <input type="text" name="name" placeholder="Your Name" required><br><br>
      <input type="tel" name="phone" placeholder="Phone Number" required><br><br>
      <button type="submit">Unlock Gift Box</button>
    </form>
    <div id="errorMsg" style="color:red;"></div>
  </div>

  <div class="gift-section" id="giftSection" style="display:none;">
    <div class="gift-box" onclick="openGift()">üéÅ Tap to Open Gift</div>
    <div class="coupon" id="couponResult"></div>
  </div>

  <script>
    let userData = {};
    let couponDrawn = false;

    document.getElementById("userForm").addEventListener("submit", function(e) {
      e.preventDefault();
      userData.name = e.target.name.value.trim();
      userData.phone = e.target.phone.value.trim();

      // Disable empty inputs
      if (!userData.name || !userData.phone) return;

      // Hide form, show gift box
      document.getElementById("formSection").style.display = "none";
      document.getElementById("giftSection").style.display = "block";
    });

    function openGift() {
      if (couponDrawn) return;

      // üéØ Random draw logic
      const chance = Math.random();
      let chosen;
      if (chance < 0.15) {
        chosen = { type: "15% OFF", prefix: "NBX15" };
      } else if (chance < 0.575) {
        chosen = { type: "10% OFF", prefix: "NBX10" };
      } else {
        chosen = { type: "Better Luck Next Time", prefix: "NBTX" };
      }

      const serial = chosen.prefix + "-" + Math.floor(1000 + Math.random() * 9000);
      const resultText = (chosen.type === "Better Luck Next Time")
        ? `üò¢ ${chosen.type}\nSerial Code: ${serial}`
        : `üéâ You got ${chosen.type}!\nCoupon Code: ${serial}`;

      document.getElementById("couponResult").innerText = resultText;
      couponDrawn = true;

      // Send to Google Sheet via POST (CORS-safe version must match your backend)
      fetch("https://script.google.com/macros/s/AKfycbyqAjJWavkB0hdbUU5mpXdRjJR_OBmqF1rz_fl_pTeT6NV1C5tpOQKBZxJfmLvnb8AJ-g/exec", {
        method: "POST",
        body: JSON.stringify({
          name: userData.name,
          phone: userData.phone,
          couponType: chosen.type,
          serial: serial
        }),
        headers: {
          "Content-Type": "application/json"
        }
      })
      .then(res => res.text())
      .then(response => {
        if (response === "Duplicate") {
          document.getElementById("giftSection").style.display = "none";
          document.getElementById("formSection").style.display = "block";
          document.getElementById("errorMsg").innerText = "‚ö†Ô∏è You have already claimed your coupon!";
        }
      })
      .catch(() => alert("‚ö†Ô∏è Error submitting your coupon!"));
    }
  </script>
</body>
</html>

